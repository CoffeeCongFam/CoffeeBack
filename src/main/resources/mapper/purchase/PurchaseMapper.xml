<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="com.ucamp.coffee.domain.purchase.mapper.PurchaseMapper">

	<!-- 소비자의 전체 주문 조회 -->
	<select id="selectAllPurchase" parameterType="map"
		resultType="PurchaseAllResponseDTO">
		SELECT bm.NAME AS sender, rm.NAME AS receiver,
		s.SUBSCRIPTION_NAME,
		s.SUBSCRIPTION_ID,
		p.CREATED_AT as paidAt, p.PURCHASE_ID,
		ms.MEMBER_SUBSCRIPTION_ID,
		p.PAYMENT_STATUS, p.IS_GIFT, s.PRICE As
		paymentAmount,
		p.GIFT_MESSAGE
		FROM
		PURCHASE p
		JOIN MEMBER bm ON
		p.MEMBER_ID = bm.MEMBER_ID
		JOIN MEMBER rm ON
		p.RECEIVER_MEMBER_ID =
		rm.MEMBER_ID
		JOIN SUBSCRIPTION s ON
		p.SUBSCRIPTION_ID =
		s.SUBSCRIPTION_ID
		JOIN MEMBER_SUBSCRIPTION ms ON
		p.PURCHASE_ID =
		ms.PURCHASE_ID
		WHERE bm.MEMBER_ID = #{memberId}

		<if test="type == 'gift'">
			AND p.IS_GIFT = 'Y'
		</if>
		<if test="type == 'mine'">
			AND p.IS_GIFT = 'N'
		</if>

		ORDER BY
		p.created_at desc
	</select>

</mapper>